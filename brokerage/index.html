<!doctype html>
<html>

<head>

    <link href="template.css" type="text/css" rel="stylesheet" />

    <title>Ian's Brokerage</title>
    
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id='loadingDiv'>
        <h1>LOADING</h1>
    </div>
    <div id='loginDiv' class='hidden'>
        Email:
        <input type='text' id='loginEmail'></input>
        Password:
        <input type='password' id='loginPassword'></input>
        <button id='loginButton'>Login</button>
    </div>
    
    <div id='contentDiv' class='hidden'>
        <button id='logout'>Log Out</button>
        <br />
        <h2>Current Price:</h2>
        <h1 id='currentPrice'></h1>
        <button id='refreshCurrentPrice'>Refresh</button>
        <h2>Total ETH:</h2>
        <h3 id='totalEth'></h3>
        <h2>Value in USD:</h2>
        <h3 id='currentValue'></h3>
		<h2>Total Portfolio Value:</h2>
		<h3 id='totalUsd'></h3>
        <h2 id='percentageGainLabel'>Percentage gain:</h2>
        <h3 id='percentGain'></h3>
		
		<button id='toggleHistory'></button>
		<div id='historyDiv'>
			<ul id='history'>
			</ul>
		</div>
        
        <div id='adminConsole' class='hidden'>
            Target Id:
            <input type='number' id='targetPersonId'></input>
            <p />
			<select id='action'>
				<option value='BUY'>BUY</option>
				<option value='SELL'>SELL</option>
				<option value='DEPOSIT'>DEPOSIT</option>
				<option value='WITHDRAW'>WITHDRAW</option>
			</select>
			Debt type:
			<input type='text' id='debtType'></input>
			Credit type:
			<input type='text' id='creditType'></input>
			Debt amount:
			<input type='text' id='debtAmount'></input>
			Credit amount:
			<input type='text' id='creditAmount'></input>
            Price:
            <input type='text' id='price'></input>
            <button id='addTransaction'>Add Transaction</button>
            <p />
            Permission Name:
            <input type='text' id='permissionName'></input>
            <button id='grantPermission'>Grant</button>
            <button id='revokePermission'>Revoke</button>
            
            <br />
            Email:
            <input type='text' id='signupEmail'></input>
            Password:
            <input type='password' id='signupPassword'></input>
            First Name:
            <input type='text' id='signupFirst'></input>
            Last Name:
            <input type='text' id='signupLast'></input>
            <button id='signupButton'>Register</button>
        </div>
    </div>
<script>
var DEBUG = false;
var ENDPOINT = "/broker/";

var transactions = [];

var marketUrl = null;

window.onload = function() {
    if (!DEBUG && location.protocol != "https:") {
        location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        return;
    }
	toggleHistory();
    
    document.getElementById('loginButton').onclick = login;
    
    document.getElementById('logout').onclick = logout;
    document.getElementById('refreshCurrentPrice').onclick = refreshCurrentPrice;
	document.getElementById('toggleHistory').onclick = toggleHistory;
    
    document.getElementById('addTransaction').onclick = addTransaction;
    document.getElementById('grantPermission').onclick = grantPermission;
    document.getElementById('revokePermission').onclick = revokePermission;
    document.getElementById('signupButton').onclick = signup;
    
    loadTransactions();
};

function login() {
    var email = document.getElementById('loginEmail').value;
    var password = document.getElementById('loginPassword').value;
    
    if (email.length === 0 || password.length === 0) {
        return;
    }
    
    var obj = {
        email: email,
        password: password
    };
    
    sendRequest('POST', 'login', JSON.stringify(obj), loadTransactions);
};

function logout() {
    sendRequest('POST', 'logout', '', function() {
        document.getElementById('contentDiv').style.display = 'none';
        document.getElementById('loginDiv').style.display = 'block';
    });
};

//

function loadTransactions() {
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('contentDiv').style.display = 'none';
    document.getElementById('loginDiv').style.display = 'none';
    
    sendRequest('GET', 'transaction', '', function(res) {
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('contentDiv').style.display = 'block';
        
        var json = JSON.parse(res);
        transactions = json.data.transactions;
        
        refreshCurrentPrice();
    }, function(err) {
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('loginDiv').style.display = 'block';
    });
};

function refreshCurrentPrice() {
    if (marketUrl !== null) {
        getLivePrice();
        return;
    }
    sendRequest('GET', 'market', '', function(res) {
        marketUrl = JSON.parse(res).data.url;
        getLivePrice();
    });
};

function getLivePrice() {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState === 4) {
            if (this.status === 200) {
                var json = JSON.parse(this.responseText);
                var bidPrice = parseFloat(json.bids[0][0]);
                var askPrice = parseFloat(json.asks[0][0]);
                var price = (bidPrice + askPrice) / 2.0;
                
                document.getElementById('currentPrice').innerHTML = "$" + twoDecimalPlaces(price);
                
                buildTransactions(price);
            } else {
                console.log("Error making GDAX request");
            }
        }
    };
    xmlhttp.open('GET', marketUrl, true);
    xmlhttp.send('');
};

function buildTransactions(tickerPrice) {
    var totalUsdIn = 0;
	var totalUsd = 0;
    var totalEth = 0;
	
	var transactionList = document.getElementById('history');
	dropChildren(transactionList);
    
    for (var ndx in transactions) {
        var txn = transactions[ndx];
		var action = txn.action;
		var debtType = txn.debtType;
		var creditType = txn.creditType;
		var debtAmount = parseFloat(txn.debtAmount);
		var creditAmount = parseFloat(txn.creditAmount);
		var price = parseFloat(txn.price);
		var timestamp = txn.updated_timestamp;
		
		var liContent = "";
        
		if (txn.action === 'DEPOSIT') {
			if (creditType === 'USD') {
				totalUsdIn += creditAmount;
				totalUsd += creditAmount;
			} else if (creditType === 'ETH') {
				totalEth += creditAmount;
			}
			liContent = "Deposited " + creditAmount + " " + creditType;
		}
        if (txn.action === 'BUY') {
            totalEth += creditAmount;
			totalUsd -= debtAmount;
			liContent = "Bought " + creditAmount + " " + creditType +
				" for " + debtAmount + " " + debtType + " (price: $" + price + ")";
        }
		if (txn.action === 'SELL') {
			totalEth -= debtAmount;
			totalUsd += creditAmount;
			liContent = "Sold " + debtAmount + " " + debtType +
				" for " + creditAmount + " " + creditType + " (price: $" + price + ")";
		}
		if (txn.action === 'WITHDRAW') {
			if (debtType === 'USD') {
				totalUsd -= debtAmount;
				totalUsdIn -= debtAmount;
			} else if (debtType === 'ETH') {
				totalEth -= debtAmount;
			}			
			liContent = "Withdrew " + debtAmount + " " + debtType;
		}
		
		var li = document.createElement('li');
		li.innerHTML = liContent;
		transactionList.append(li);
    }
    var currentValue = totalEth * tickerPrice;
	var fullUsdValue = currentValue + totalUsd;
    
    document.getElementById('totalEth').innerHTML = totalEth;
    document.getElementById('currentValue').innerHTML = '$' + twoDecimalPlaces(currentValue);
	document.getElementById('totalUsd').innerHTML = "$" + twoDecimalPlaces(fullUsdValue);
	document.getElementById('percentageGainLabel').innerHTML = "Percentage gain (based on $" + totalUsdIn + " deposited):";
    document.getElementById('percentGain').innerHTML = twoDecimalPlaces((((fullUsdValue - totalUsdIn) / totalUsdIn) * 100)) + "%";
};

function toggleHistory() {
	var historyDiv = document.getElementById("historyDiv");
	var isHidden = historyDiv.className === 'hidden';
	historyDiv.className = isHidden ? '' : 'hidden';
	document.getElementById('toggleHistory').innerHTML = isHidden ? 'Hide History' : 'Show History';
}

//

function toggleAdminConsole() {
    var adminConsole = document.getElementById('adminConsole');
    adminConsole.className = adminConsole.className === 'hidden' ? '' : 'hidden';
};

function addTransaction() {
    var targetId = document.getElementById('targetPersonId').value;
    var action = document.getElementById('action').value;
	var debtType = document.getElementById('debtType').value;
	var creditType = document.getElementById('creditType').value;
	var debtAmount = document.getElementById('debtAmount').value;
	var creditAmount = document.getElementById('creditAmount').value;
    var price = document.getElementById('price').value;
    
    var obj = {
        targetPersonId: targetId,
        action: action,
		debtType: debtType,
		creditType: creditType,
		debtAmount: debtAmount,
		creditAmount: creditAmount,
        price: price
    };
    sendRequest('POST', 'transaction', JSON.stringify(obj), loadTransactions);
};

function grantPermission() {
    var targetId = document.getElementById('targetPersonId').value;
    var permission = document.getElementById('permissionName').value;
    var obj = {
        targetPersonId: targetId,
        permission: permission
    };
    sendRequest('POST', 'permission', JSON.stringify(obj));
};

function revokePermission() {
    var targetId = document.getElementById('targetPersonId').value;
    var permission = document.getElementById('permissionName').value;
    var obj = {
        targetPersonId: targetId,
        permission: permission
    };
    sendRequest('DELETE', 'permission', JSON.stringify(obj));
};

function signup() {
    var email = document.getElementById('signupEmail').value;
    var password = document.getElementById('signupPassword').value;
    var firstName = document.getElementById('signupFirst').value;
    var lastName = document.getElementById('signupLast').value;
    
    var obj = {
        email: email,
        password: password,
        first_name: firstName,
        last_name: lastName
    };
    
    sendRequest('POST', 'person', JSON.stringify(obj));
};

//

function twoDecimalPlaces(flt) {
	return parseFloat(flt).toFixed(2);
};

function dropChildren(elem) {
	while (elem.firstChild) {
		elem.removeChild(elem.firstChild);
	}
};

function sendRequest(method, url, body, successCallback, failCallback) {
    //updateStatus("Sending request...");
    
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
                console.log("Response status: " + this.status);
                console.log(this.responseText);
            if (this.status == 200) {
                //updateStatus("SUCCESS");
                if (successCallback != undefined) {
                    successCallback(this.responseText);
                }
            } else {
                //updateStatus("ERROR: " + this.responseText);
                if (failCallback != undefined) {
                    failCallback(this.responseText);
                }
            }
        }
    }
        console.log("Making request to: " + ENDPOINT + url);
    xmlhttp.open(method, ENDPOINT + url, true);
    if (body !== undefined) {
        console.log(body);
    }
    xmlhttp.send(body !== undefined ? body : "");
};
</script>
</body>
</html>

