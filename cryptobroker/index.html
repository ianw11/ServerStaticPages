<!doctype html>
<html>
<head>
    <title>Crypto Exchange Dev Portal</title>
    
    <style>
        .green {
            background-color: green;
            font-weight: bold;
        }
        
        .red {
            background-color: red;
            font-weight: bold;
        }
        
        .yellow {
            background-color: yellow;
            font-weight: bold;
        }
        
        .orange {
            background-color: orange;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .modalClose {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .modalClose:hover,
        .modalClose:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Crypto Broker</h1>
    <h2 id='status'></h2>
    <p id='sessionStatus'>-</p>
    
    <div id='loginDiv'>
        <h3>Sign up or login</h3>
        Email:
        <input id='email_login' type='text'></input>
        Password:
        <input id='password_login' type='text'></input>
        <button id='loginButton' class='orange'>Login</button>
        <button id='showRegisterModalButton' class='orange'>Register</button>
        <div class='modal' id='registerModal'>
            <div class='modal-content'>
                <span class='modalClose'>&times;</span>
                Email:
                <input id='email' type='text'></input>
                Password:
                <input id='password' type='text'></input>
                First name:
                <input id="firstname" type='text'></input>
                Last name:
                <input id='lastname' type='text'></input>
                <button id='registerButton' class='orange'>Register</button>
            </div>
        </div>
    </div>
    
    <div id="content" class='hidden'>
        <button id='addAccountPopup' class='red'>Add Account</button>
        
        <h3>Wallets</h3>
        <button id='updateWalletsButton' class='yellow'>Update Wallets</button>
        <div id='wallets'>
        </div>
        
        <div class='modal' id='modal'>
            <div class='modal-content'>
                <span class='modalClose'>&times;</span>
                
                <h3>Add new account</h3>
        
                Exchange:
                <select id='exchangeSelect'></select>
                <br />
                apikey:
                <input id='apikey' type='text'></input>
                <br />
                passphrase:
                <input id='passphrase' type='text'></input>
                <br />
                secret:
                <input id='secret' type='text'></input>
                <br />
                <button id='addAccount' class='green'>Add</button>
            </div>
        </div>
    </div>

<script>
var DEBUG = true;
var ENDPOINT = "/crypto/";

//var accessToken = '';

window.onload = function() {
    document.getElementById('loginButton').onclick = login;
    document.getElementById('showRegisterModalButton').onclick = showRegisterModal;
    document.getElementById('registerButton').onclick = register;
    document.getElementById('addAccount').onclick = addAccount;
    document.getElementById('addAccountPopup').onclick = addAccountPopup;
    document.getElementById('updateWalletsButton').onclick = updateWallets;
    
    var modalCloses = document.getElementsByClassName('modalClose');
    for (var ndx in modalCloses) {
        modalCloses[ndx].onclick = closeModal;
    }
    
    sendRequest('GET', 'exchanges', null, function(result) {
        var select = document.getElementById('exchangeSelect');
        
        var data = result.data;
        for (var key in data) {
            var option = document.createElement('option');
            option.innerHTML = data[key];
            option.value = key;
            select.append(option);
        }
    });
};

function register() {
    closeModal();
    
    var email = document.getElementById('email').value;
    var password = document.getElementById('password').value;
    var firstname = document.getElementById('firstname').value;
    var lastname = document.getElementById('lastname').value;
    
    var param = {
        email: email,
        password: password,
        first_name: firstname,
        last_name: lastname
    };
    
    sendRequest('POST', 'register', JSON.stringify(param));
};

function showRegisterModal() {
    var modal = document.getElementById('registerModal');
    modal.style.display = 'block';
    
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    document.getElementById('firstname').value = '';
    document.getElementById('lastname').value = '';
};

function login() {
    var email = document.getElementById('email_login').value;
    var password = document.getElementById('password_login').value;
    
    var param = {
        email: email,
        password: password
    };
    
    sendRequest('POST', 'login', JSON.stringify(param), function(result) {
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        updateWallets();
    });
};

function addAccount() {
    closeModal();
    
    var exchange = document.getElementById('exchangeSelect').value;
    var apikey = document.getElementById('apikey').value;
    var passphrase = document.getElementById('passphrase').value;
    var secret = document.getElementById('secret').value;
    
    if (apikey === '') {
        updateStatus('Enter an api key');
        return;
    }
    
    var param = {
        exchange: exchange,
        apikey: apikey,
        passphrase: passphrase,
        secret: secret
    };
    
    sendRequest('POST', 'addExchange', JSON.stringify(param));
};

function addAccountPopup() {
    var popup = document.getElementById('modal');
    popup.style.display = 'block';
    
    document.getElementById('apikey').value = '';
    document.getElementById('passphrase').value = '';
    document.getElementById('secret').value = '';
};

function updateWallets() {
    var output = document.getElementById('wallets');
    dropChildren(output);
        
    sendRequest('GET', 'wallets', null, function(result) {
        for (var tag in result.data) {
            var account = result.data[tag];
            var exchangeTitle = document.createElement('p');
            exchangeTitle.className = 'red';
            exchangeTitle.innerHTML = account.displayName;
            output.append(exchangeTitle);
            
            for (var ndx in account.wallets) {
                var wallet = account.wallets[ndx];
                
                var p = document.createElement('p');
                p.innerHTML = wallet.currency + " -- " + wallet.balance;
                output.append(p);
            }
        }
    });
};

function closeModal() {
    document.getElementById('modal').style.display = 'none';
    document.getElementById('registerModal').style.display = 'none';
};

function sendRequest(method, url, body, successCallback, failCallback) {
    updateStatus("Sending request...");
    
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
            if (DEBUG) {
                console.log("Response status: " + this.status);
                console.log(this.responseText);
            }
            if (this.status == 200) {
                var obj = JSON.parse(this.responseText);
                accessToken = obj.access_token;
                if (successCallback != undefined) {
                    successCallback(obj);
                }
                updateStatus("SUCCESS");
            } else {
                accessToken = '';
                updateStatus("ERROR: " + this.responseText);
                if (failCallback != undefined) {
                    failCallback(JSON.parse(this.responseText));
                }
            }
        }
    }
    if (DEBUG) {
        console.log("Making " + method +" request to: " + ENDPOINT + url);
        console.log(body);
        //console.log('access token: ' + accessToken);
    }
    xmlhttp.open(method, ENDPOINT + url, true);
    //xmlhttp.setRequestHeader("access_token", accessToken);
    xmlhttp.send(body !== undefined ? body : "");
};

function updateStatus(message) {
    document.getElementById('status').innerHTML = message;
    /*
    var sessionStatus = document.getElementById('sessionStatus');
    if (accessToken === '') {
        sessionStatus.innerHTML = "Not logged in";
        sessionStatus.className = "red";
    } else {
        sessionStatus.innerHTML = "Logged in";
        sessionStatus.className = "green";
    }
    */
};

function dropChildren(elem) {
	while (elem.firstChild) {
		elem.removeChild(elem.firstChild);
	}
};
</script>
</body>
</html>