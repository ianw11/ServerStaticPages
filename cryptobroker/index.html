<!doctype html>
<html>
<head>
    <title>Crypto Exchange Dev Portal</title>
    
    <style>
        .totals {
            background-color: #00B159;

            border-radius: 25px;
            border: 2px solid #000;
            padding: 10px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .accountUp {
            background-color: #FFC425;
            border-radius: 25px;
            border: 2px solid #000;
            padding: 10px;
        }
        
        .accountDown {
            background-color: #F37735;
            border-radius: 25px;
            border: 2px solid #000;
            padding: 10px;
        }
    
        .green {
            background-color: green;
            font-weight: bold;
        }
        
        .red {
            background-color: red;
            font-weight: bold;
        }
        
        .yellow {
            background-color: yellow;
            font-weight: bold;
        }
        
        .orange {
            background-color: orange;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        table {
            border-spacing: 10px;
        }
        
        /* Spinning loader styles */
        
        .loader {
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Styles */
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .modalClose {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .modalClose:hover,
        .modalClose:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Accordion styles */
        
        .accordionWrapper {
            width: 600px;
            margin-left: auto;
            margin-right: auto;
            background-color: #fff;
        }
        .accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            text-align: left;
            outline: none;
            border: none;
            transition: 0.4s;
        }
        .accordion.active, .accordion:hover {
            background-color: aquamarine;
        }
        div.panel {
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
        .accordion:after {
            content: "\02795";
            font-size: 13px;
            color: #777;
            float: right;
            margin-left: 5px;
        }
        .accordion.active:after {
            content: '\2796';
        }
    </style>
</head>
<body>
    <h1>Crypto Broker</h1>
    <h2 id='status'></h2>
    <p id='sessionStatus'>-</p>
    
    <div id='loginDiv'>
        <h3>Sign up or login</h3>
        Email:
        <input id='email_login' type='text'></input>
        Password:
        <input id='password_login' type='text'></input>
        <button id='loginButton' class='orange'>Login</button>
        <button id='showRegisterModalButton' class='orange'>Register</button>
        <div class='modal' id='registerModal'>
            <div class='modal-content'>
                <span class='modalClose'>&times;</span>
                First name:
                <input id="firstname" type='text'></input>
                Last name:
                <input id='lastname' type='text'></input>
                Email:
                <input id='email' type='text'></input>
                Password:
                <input id='password' type='text'></input>
                <button id='registerButton' class='orange'>Register</button>
            </div>
        </div>
    </div>
    
    <div id="content" class='hidden'>
        <button id='addAccountPopup' class='orange'>Add Account</button>
        <div class='modal' id='modal'>
            <div class='modal-content'>
                <span class='modalClose'>&times;</span>
                
                <h3>Add new account</h3>
        
                Exchange:
                <select id='exchangeSelect'></select>
                <br />
                apikey:
                <input id='apikey' type='text'></input>
                <br />
                passphrase:
                <input id='passphrase' type='text'></input>
                <br />
                secret:
                <input id='secret' type='text'></input>
                <br />
                <button id='addAccount' class='green'>Add</button>
            </div>
        </div>
        
        <button id='updateWalletsButton' class='yellow'>Update Wallets</button>
        <button id='updateConversionsButton' class='yellow'>Update Conversions</button>
        <button id='updateTransactions' class='yellow'>Update Transactions</button>
        <div id='totals'>
        </div>
        <div id='wallets'>
        </div>
        <div class='modal' id='nicknameModal'>
            <div class='modal-content'>
                <span class='modalClose'>&times;</span>
                Nickname:
                <input type='text' id='nickname'></input>
                <button id='setNickname'>Set</button>
            </div>
        </div>
    </div>

<script>
var DEBUG = true;
var ENDPOINT = "/crypto/";

var id;

window.onload = function() {
    document.getElementById('loginButton').onclick = login;
    document.getElementById('showRegisterModalButton').onclick = showRegisterModal;
    document.getElementById('registerButton').onclick = register;
    document.getElementById('addAccount').onclick = addAccount;
    document.getElementById('addAccountPopup').onclick = addAccountPopup;
    document.getElementById('updateWalletsButton').onclick = updateWallets;
    document.getElementById('updateConversionsButton').onclick = updateConversions;
    document.getElementById('updateTransactions').onclick = updateTransactions;
    document.getElementById('setNickname').onclick = setNickname;
    
    var modalCloses = document.getElementsByClassName('modalClose');
    for (var ndx in modalCloses) {
        modalCloses[ndx].onclick = closeModal;
    }
    
    sendRequest('GET', 'exchanges', null, function(result) {
        var select = document.getElementById('exchangeSelect');
        
        var data = result.data;
        for (var key in data) {
            var option = document.createElement('option');
            option.innerHTML = data[key];
            option.value = key;
            select.append(option);
        }
    });
};

function register() {
    closeModal();
    
    var email = document.getElementById('email').value;
    var password = document.getElementById('password').value;
    var firstname = document.getElementById('firstname').value;
    var lastname = document.getElementById('lastname').value;
    
    var param = {
        email: email,
        password: password,
        first_name: firstname,
        last_name: lastname
    };
    
    sendRequest('POST', 'register', JSON.stringify(param));
};

function showRegisterModal() {
    var modal = document.getElementById('registerModal');
    modal.style.display = 'block';
    
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    document.getElementById('firstname').value = '';
    document.getElementById('lastname').value = '';
};

function login() {
    var loginButton = document.getElementById('loginButton');
    loginButton.disabled = true;
    
    var email = document.getElementById('email_login').value;
    var password = document.getElementById('password_login').value;
    
    var param = {
        email: email,
        password: password
    };
    
    sendRequest('POST', 'login', JSON.stringify(param), function(result) {
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        updateWallets();
        
        loginButton.disabled = false;
    }, function() {
        loginButton.disabled = false;
    });
};

function addAccount() {
    closeModal();
    
    var exchange = document.getElementById('exchangeSelect').value;
    var apikey = document.getElementById('apikey').value;
    var passphrase = document.getElementById('passphrase').value;
    var secret = document.getElementById('secret').value;
    
    if (apikey === '') {
        updateStatus('Enter an api key');
        return;
    }
    
    var param = {
        exchange: exchange,
        apikey: apikey,
        passphrase: passphrase,
        secret: secret
    };
    
    sendRequest('POST', 'addExchange', JSON.stringify(param), function() {
        updateWallets();
    });
};

function addAccountPopup() {
    var popup = document.getElementById('modal');
    popup.style.display = 'block';
    
    document.getElementById('apikey').value = '';
    document.getElementById('passphrase').value = '';
    document.getElementById('secret').value = '';
};

function updateWallets() {
    var updateButton = document.getElementById('updateWalletsButton');
    updateButton.disabled = true;

    var output = document.getElementById('wallets');
    dropChildren(output);
        
    sendRequest('GET', 'wallets', null, function(result) {
        var isUp = false;
        for (var tag in result.data) {
            var account = result.data[tag];
            
            var accountDiv = document.createElement('div');
            accountDiv.className = isUp ? 'accountUp' : 'accountDown';
            isUp = !isUp;
            
            var exchangeTitle = document.createElement('h2');
            exchangeTitle.innerHTML = account.nickname + " (" + account.displayName + " " + account.apiTrunc + "...)";
            accountDiv.append(exchangeTitle); // COMMENT IF ACCORDION
            
            if (account.wallets.length > 0) {
            
                // Build a table holding currency type, balance, and conversion (to USD)
                var table = document.createElement('table');
                
                // And kick off with a header row
                var headerRow = document.createElement('tr');
                var headerCurrency = document.createElement('th');
                headerCurrency.innerHTML = 'CURRENCY';
                headerRow.append(headerCurrency);
                var headerBalance = document.createElement('th');
                headerBalance.innerHTML = 'BALANCE';
                headerRow.append(headerBalance);
                var headerConversion = document.createElement('th');
                headerConversion.innerHTML = 'USD CONVERSION (Last trade price)';
                headerRow.append(headerConversion);
                var headerUsdTotal = document.createElement('th');
                headerUsdTotal.innerHTML = 'USD TOTAL';
                headerRow.append(headerUsdTotal);
                table.append(headerRow);
                
                
                for (var ndx in account.wallets) {
                    var wallet = account.wallets[ndx];
                    var walletRow = document.createElement('tr');
                    
                    var currencyCell = document.createElement('td');
                    currencyCell.innerHTML = wallet.currency;
                    walletRow.append(currencyCell);
                    
                    var balanceCell = document.createElement('td');
                    // THE ID IS <ACCOUNT_ID>+<CURRENCY>+balance
                    balanceCell.id = account.id + wallet.currency + 'balance';
                    balanceCell.innerHTML = wallet.balance;
                    balanceCell.currency = wallet.currency;
                    balanceCell.className = 'walletBalance';
                    walletRow.append(balanceCell);
                    
                    var conversionCell = document.createElement('td');
                    // THE ID IS <ACCOUNT_ID>+<CURRENCY>
                    conversionCell.id = account.id + wallet.currency;
                    walletRow.append(conversionCell);
                    
                    var usdTotalCell = document.createElement('td');
                    // THE ID IS <ACCOUNT_ID>+<CURRENCY>+total
                    usdTotalCell.id = account.id + wallet.currency + 'total';
                    walletRow.append(usdTotalCell);
                    
                    table.append(walletRow);
                }
                accountDiv.append(table);
            
            }
            
            // Account total
            var totalTitle = document.createElement('h3');
            totalTitle.innerHTML = "Account total in USD";
            accountDiv.append(totalTitle);
            var totalAmount = document.createElement('p');
            totalAmount.className = 'accountTotal';
            totalAmount.id = account.id + 'total';
            totalAmount.innerHTML = "0.00";
            accountDiv.append(totalAmount);
            
            // Nickname button
            var button = document.createElement('button');
            button.innerHTML = "Set Nickname";
            button.className = 'orange';
            button.id = account.id;
            button.onclick = function() {
                id = this.id;
                document.getElementById('nicknameModal').style.display = 'block';
                document.getElementById('nickname').value = '';
            };
            accountDiv.append(button);
            
            // Delete button
            var deleteButton = document.createElement('button');
            deleteButton.innerHTML = 'DELETE EXCHANGE';
            deleteButton.className = 'red';
            deleteButton.id = account.id;
            deleteButton.onclick = function() {
                var param = { id : this.id };
                sendRequest('DELETE', 'exchange', JSON.stringify(param), function() {
                    updateWallets();
                });
            };
            accountDiv.append(deleteButton);
            
            // Space then the transactions accordion
            accountDiv.append(document.createElement('p'));
            
            var accordionHolder = document.createElement('div');
            accordionHolder.id = account.id + 'transactions';
            accountDiv.append(accordionHolder);
            
            //output.append(buildAccordion(exchangeTitle, accountDiv));
            output.append(accountDiv);
        }
        
        updateConversions();
        updateButton.disabled = false;
    }, function() {
        updateButton.enabled = false;
    });
};

function updateConversions() {
    var conversionsButton = document.getElementById('updateConversionsButton');
    conversionsButton.disabled = true;

    var walletTotals = document.getElementById('totals');
    dropChildren(walletTotals);
    var loaderDiv = document.createElement('div');
    loaderDiv.className = 'loader';
    walletTotals.append(loaderDiv);
    
    sendRequest('GET', 'usdConversions', null, function(res) {
        for (var tag in res.data) {
            var account = res.data[tag];
            
            var accountSum = 0;
            
            for (var ndx in account.conversions) {
                var conversion = account.conversions[ndx];
                
                var lastTradePrice = conversion.lastTradePrice;
                
                var tag = account.id + conversion.from;
                
                var conversionElem = document.getElementById(tag);
                if (conversionElem === null) {
                    continue;
                }
                conversionElem.innerHTML = lastTradePrice;
                
                var totalElem = document.getElementById(tag + 'total');
                var balanceElem = document.getElementById(tag + 'balance');
                var total = parseFloat(lastTradePrice) * parseFloat(balanceElem.innerHTML);
                totalElem.innerHTML = total;
                accountSum += total;
            }
            
            var accountTotalElem = document.getElementById(account.id + 'total');
            accountTotalElem.innerHTML = accountSum;
        }
        
        updateTotals();
        conversionsButton.disabled = false;
    }, function() {
        conversionsButton.disabled = false;
    });
};

function updateTotals() {
    var walletTotals = document.getElementById('totals');
    
    var totalDiv = document.createElement('div');
    totalDiv.className = 'totals';
    
    // First compute the total USD value based on the account total of each account
    var items = document.getElementsByClassName('accountTotal');
    var usdTotal = 0;
    for (var i = 0; i < items.length; ++i) {
        var elem = items[i];
        var value = parseFloat(elem.innerHTML);
        usdTotal += value;
    }
    var usdTotalElem = document.createElement('h2');
    usdTotalElem.innerHTML = "TOTAL USD VALUE: " + usdTotal;
    totalDiv.append(usdTotalElem);
    
    // Then display the sum of each coin across all accounts
    var totals = {};
    var balances = document.getElementsByClassName('walletBalance');
    for (var i = 0; i < balances.length; ++i) {
        var elem = balances[i];
        var currency = elem.currency;
        if (totals[currency] === undefined) {
            totals[currency] = 0;
        }
        totals[currency] += parseFloat(elem.innerHTML);
    }
    var table = document.createElement('table');
    var titleRow = document.createElement('tr');
    var title = document.createElement('th');
    title.innerHTML = "Coin";
    titleRow.append(title);
    var titleBalance = document.createElement('th');
    titleBalance.innerHTML = "Total Balance (across all accounts)";
    titleRow.append(titleBalance);
    table.append(titleRow);
    
    for (var key in totals) {
        var row = document.createElement('tr');
        var name = document.createElement('td');
        name.innerHTML = key;
        var value = document.createElement('td');
        value.innerHTML = totals[key];

        row.append(name);
        row.append(value);
        table.append(row);
    }
    totalDiv.append(table);
    
    dropChildren(walletTotals);
    walletTotals.append(totalDiv);
};

function updateTransactions() {
    sendRequest('GET', 'transactions', null, function(res) {
        for (var id in res.data) {
            var transactions = res.data[id];
            if (transactions.length == 0) {
                continue;
            }
            
            var deposits = {'USD' : 0};
            var withdrawals = {'USD' : 0};
            
            var content = document.createElement('ul');
            for (var ndx in transactions) {
                var transaction = transactions[ndx];
                var type = transaction.type;
                
                var transactionElem = document.createElement('div');
                if (type === 'BUY') {
                    transactionElem.className = 'green';
                } else if (type === 'SELL') {
                    transactionElem.className = 'red';
                } else if (type === 'DEPOSIT') {
                    transactionElem.className = 'yellow';
                    
                    if (deposits[transaction.creditType] == undefined) {
                        deposits[transaction.creditType] = 0;
                    }
                    deposits[transaction.creditType] += parseFloat(transaction.creditAmount);
                } else if (type === 'WITHDRAWAL') {
                    transactionElem.className = 'yellow';
                    
                    if (withdrawals[transaction.debtType] == undefined) {
                        withdrawals[transaction.debtType] = 0;
                    }
                    withdrawals[transaction.debtType] += parseFloat(transaction.debtAmount);
                }
                
                // Build the transaction details
                var h3 = document.createElement('h3');
                var str = type + " ";
                if (type === 'BUY') {
                    str += " ";
                }
                if (type !== 'WITHDRAWAL') {
                    str += eightDecimalPlaces(transaction.creditAmount) + " " + transaction.creditType;
                }
                if (type === "BUY" || type === "SELL") {
                    str += " for ";
                }
                if (type !== 'DEPOSIT') {
                    str += eightDecimalPlaces(transaction.debtAmount) + " " + transaction.debtType;
                }
                if (type === "BUY" || type === "SELL") {
                    str += " at " + eightDecimalPlaces(transaction.price);
                }
                h3.innerHTML = str;
                transactionElem.append(h3);
                
                // Build the date
                var date = new Date(transaction.timestamp);
                var p = document.createElement('p');
                p.innerHTML = date;
                transactionElem.append(p);
                
                content.append(transactionElem);
            }
            
            var sumDepositsElem = document.createElement('h3');
            sumDepositsElem.innerHTML = 'Total USD deposits: ' + deposits['USD'];
            content.append(sumDepositsElem);
            
            var sumWithdrawalsElem = document.createElement('h3');
            sumWithdrawalsElem.innerHTML = 'Total USD withdrawals: ' + withdrawals['USD'];
            content.append(sumWithdrawalsElem);
            
            var titleElem = document.createElement('h2');
            titleElem.innerHTML = "Transactions";
            
            var holderElem = document.getElementById(id + 'transactions');
            dropChildren(holderElem);
            holderElem.append(buildAccordion(titleElem, content));
        }
    });
};

function setNickname() {
    var button = document.getElementById('setNickname');
    button.enabled = false;
    
    var nickname = document.getElementById('nickname').value;
    var param = {
        nickname: nickname,
        id: id
    };
    sendRequest('POST', 'account/nickname', JSON.stringify(param), function() {
        updateWallets();
        closeModal();
        button.enabled = true;
    }, function() {
        button.enabled = true;
    });
    id = null;
};

function closeModal() {
    document.getElementById('modal').style.display = 'none';
    document.getElementById('registerModal').style.display = 'none';
    document.getElementById('nicknameModal').style.display = 'none';
};

/*
 * Helper methods
 */

function eightDecimalPlaces(flt) {
    return decimalPlaces(flt, 8);
};

function decimalPlaces(flt, numPlaces) {
    return parseFloat(flt).toFixed(numPlaces);
};
 
function buildAccordion(titleElem, contentElem) {
    var accordion = document.createElement('div');
    accordion.className = 'accordionWrapper';
    
    titleElem.classList.toggle('accordion');
    titleElem.onclick = function() {
        this.classList.toggle('active');
        var panel = this.nextElementSibling;
        if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
        } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
        }
    };
    accordion.append(titleElem);
    
    var contentWrapper = document.createElement('div');
    contentWrapper.append(contentElem);
    contentWrapper.classList.toggle('panel');
    accordion.append(contentWrapper);
    
    return accordion;
};

function sendRequest(method, url, body, successCallback, failCallback) {
    updateStatus("Sending request...");
    
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
            if (DEBUG) {
                console.log("Response status: " + this.status);
                console.log(this.responseText);
            }
            if (this.status == 200) {
                var obj = JSON.parse(this.responseText);
                accessToken = obj.access_token;
                if (successCallback != undefined) {
                    successCallback(obj);
                }
                updateStatus("SUCCESS");
            } else {
                accessToken = '';
                updateStatus("ERROR: " + this.responseText);
                if (failCallback != undefined) {
                    failCallback(JSON.parse(this.responseText));
                }
            }
        }
    }
    if (DEBUG) {
        console.log("Making " + method +" request to: " + ENDPOINT + url);
        console.log(body);
        //console.log('access token: ' + accessToken);
    }
    xmlhttp.open(method, ENDPOINT + url, true);
    //xmlhttp.setRequestHeader("access_token", accessToken);
    xmlhttp.send(body !== undefined ? body : "");
};

function updateStatus(message) {
    document.getElementById('status').innerHTML = message;
    /*
    var sessionStatus = document.getElementById('sessionStatus');
    if (accessToken === '') {
        sessionStatus.innerHTML = "Not logged in";
        sessionStatus.className = "red";
    } else {
        sessionStatus.innerHTML = "Logged in";
        sessionStatus.className = "green";
    }
    */
};

function dropChildren(elem) {
	while (elem.firstChild) {
		elem.removeChild(elem.firstChild);
	}
};
</script>
</body>
</html>
